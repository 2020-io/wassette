<!doctype html>
<html>
  <head>
    <!-- <script src="https://cdn.jsdelivr.net/pyodide/v0.28.2/full/pyodide.js"></script> -->
    <script src="https://cdn.jsdelivr.net/pyodide/dev/full/pyodide.js"></script>
    <script src="https://pyscript.net/releases/2025.8.1/core.js" type="module"></script>

    <script type="text/javascript">
      async function sleepFor(maxcount = null) {
        let counter = 0;
        console.log(`-> sleepFor: enter ${maxcount}`);
        if (maxcount == 0)
            maxcount = null;
        while (!maxcount || counter < maxcount) {
            //console.log(`.. sleepFor: ${counter}`);
            await new Promise(resolve => setTimeout(resolve, 1000));
            counter++;
        }
        console.log(`<- sleepFor: exit ${counter}`);
      }
    </script>
  </head>

  <body>
    <div id="status"></div><br/>
    <div id="url" style="display:none"></div>
    <div id="content">Waiting for content...</div>

    <script id="wasm" type="text/javascript">
      console.log("wasm enter", this);

      url = window.location;
      console.log("wasm location", url);
      url = url.href.split('?')[0];
      document.getElementById("url").contentText = url;

      wasm = document.getElementById("wasm");
      console.log("wasm element", wasm);
      //if (wasm)
      //  console.log("wasm body", wasm.innerHTML);

      content = document.getElementById("content");
      console.log("content element", content);
      if (content) {
        s = document.createElement('iframe');
        console.log("content body", content.innerHTML);
        content.innerHTML = "";
        src = url + ".js";
        s.src = src
        text = "Loading " + src;
      } else {
        content = document.body;
        s = document.createElement('script');
        s.type = 'text/javascript';
        text = 'alert("Called from: ' + url + '");';
      }
      console.log("text", text);

      try {
        text_node = document.createTextNode(text);
        //console.log("child text", text_node);
        s.appendChild(text_node);
        console.log("child node", s);
        content.appendChild(s);
      } catch (e) {
        console.log("exception", e);
        s.text = text;
        console.log("child node", s);
        content.appendChild(s);
      }

      console.log("wasm exit", this);
    </script>

    <script type="micropython">
      from js import document
      url = document.getElementById("url").contentText;

      import time
      msg = f"micropython enter {url}"
      print(msg)
      status = document.getElementById("status")
      status.innerText = msg

      for i in range(3):
        print(f"micropython: loop {i}")
        time.sleep(1)

      msg = f"micropython exit {url}"
      status.innerText = msg
      print(msg)
    </script>

    <script type="text/javascript">
      async function main() {
        console.log("main enter", this);

        url = this.location;
        console.log("main location", url);
        url = url.href.split('?')[0];

        //await sleepFor(1);
        //let element = null;
        //let element = document.body;
        let element = document.getElementById('status');
        if (element)
          element.textContent = "main enter " + url;

        const pyodide = await loadPyodide();
        console.log("pyodide", pyodide);

        const threading = pyodide.pyimport("threading");
        //console.log("threading", threading); // pyodide Proxy()
        const thread_id = threading.get_ident();
        console.log("thread_id", thread_id);

        // For internal pyodide packages like micropip, use loadPackage()
        const micropip = await pyodide.loadPackage("micropip");
        console.log("micropip", micropip);

        await pyodide.runPythonAsync(`
          import inspect
          self = inspect.currentframe()
          id = id(self)

          print(f"-> runPythonAsync start {id}", self)
          print("globals", globals())

          import sys
          #print("--> modules start", sorted(sys.modules.keys()))

          import micropip
          #print(micropip.list()) # shows only 'micropip'

          def localfunc():
            l_var = 123
            #print("locals", locals()) # locals() will contain 'l_var' set to 1234 
            #import time
            #for i in range(3):
            #   print(f"localfunc: loop {i}")
            #   time.sleep(1)
            #print("locals", locals()) # locals() will contain 'l_var' set to 1234 and 'i' set to 2 
          # end of def localfunc()
          localfunc()

          #print("<-- modules end", sorted(sys.modules.keys()))
          print(f"<- runPythonAsync exit {id}", self)
        `);

        console.log("main exit", this);
        if (element)
          element.textContent = "main exit " + url;
      }

      main();
    </script>
  </body>
</html>
