<!doctype html>
  <head>
    <!-- <script src="https://cdn.jsdelivr.net/pyodide/v0.28.2/full/pyodide.js"></script> -->
    <script src="https://cdn.jsdelivr.net/pyodide/dev/full/pyodide.js"></script>
    <script src="https://pyscript.net/releases/2025.8.1/core.js" type="module"></script>

    <script type="text/javascript">
      async function sleepFor(maxcount = null) {
        let counter = 0;
        console.log(`-> sleepFor: enter ${maxcount}`);
        if (maxcount == 0)
            maxcount = null;
        while (!maxcount || counter < maxcount) {
            //console.log(`.. sleepFor: ${counter}`);
            await new Promise(resolve => setTimeout(resolve, 1000));
            counter++;
        }
        console.log(`<- sleepFor: exit ${counter}`);
      }
    </script>
  </head>

  <body>
    <div id="status"></div><br/>
    <div id="url" style="display:none"></div>
    <div id="content">Waiting for content...</div>

    <script id="wasm" type="text/javascript">
      console.log("wasm enter", this);
      subwindow = this[0]
      if (subwindow) {
        console.log("subwindow", subwindow)
        console.log("subwindow.location", subwindow.location)
        //this = subwindow
      }

      url = window.location.href
      console.log("wasm location", url);
      //url = url.split('?')[0];
      document.getElementById("url").contentText = url;

      queryString = window.location.search
      console.assert(typeof(queryString) == 'string') 
      if (queryString && queryString[0] == '?')
        console.log("queryString", queryString)
      const params = new URLSearchParams(queryString)

      //wasm = document.getElementById("wasm");
      //console.log("wasm element", wasm);
      //if (wasm)
      //  console.log("wasm body", wasm.innerHTML);

      content = document.getElementById("content");
      if (content) {
        text = null;
        //console.log("previous content", content.innerHTML);
        content.innerHTML = "";

        iframe = params.get('iframe');
        if (iframe) {
          // This is the call from the injected <iframe src=...
          src = url + ".js";
          //console.log("Redirecting", src);
          //window.location = src;
        } else {
          // This is the initial call, so inject an <iframe> to reload this URL from the <iframe>
          element = document.createElement('iframe');
          element.id = 'iframe';
          src = url + "?iframe=1";
          element.src = src;
          text = "Injecting <iframe> to " + src;
        }
      } else {
        content = document.body;
        element = document.createElement('script');
        element.type = 'text/javascript';
        text = 'alert("Called from: ' + url + '");';
      }

      if (text) {
        //console.log("text", text);
        try {
          text_node = document.createTextNode(text);
          //console.log("child text", text_node);
          element.appendChild(text_node);
          console.log("adding new node", element);
          console.log("adding to parent", content);
          content.appendChild(element);
        } catch (e) {
          console.log("exception", e);
          element.text = text;
          console.log("adding new node", element);
          console.log("adding to parent", content);
          content.appendChild(element);
        }
      }

      status = document.getElementById("status");
      msg = "wasm exit " + url;
      console.log(msg);
      //console.log("wasm exit", this);
      if (status)
        status.textContent = msg;
    </script>

    <script type="micropython">
      from js import document
      url = document.getElementById("url").contentText;

      import time
      msg = f"micropython enter {url}"
      print(msg)
      status = document.getElementById("status")
      status.innerText = msg

      for i in range(1):
        print(f"micropython: loop {i}")
        time.sleep(1)

      msg = f"micropython exit {url}"
      print(msg)
      status.innerText = msg
    </script>

    <script type="text/javascript">
      async function main() {
        console.log("main enter", this);
        subwindow = this[0]
        if (subwindow) {
          console.log("subwindow", subwindow)
          console.log("subwindow.location", subwindow.location)
          //this = subwindow
        }

        url = this.location.href;
        console.log("main location", url);
        //url = url.split('?')[0];

        //await sleepFor(1);
        //let element = null;
        //let element = document.body;
        let element = document.getElementById('status');
        if (element)
          element.textContent = "main enter " + url;

        const pyodide = await loadPyodide();
        console.log("pyodide", pyodide);

        const threading = pyodide.pyimport("threading");
        //console.log("threading", threading); // pyodide Proxy()
        const thread_id = threading.get_ident();
        console.log("thread_id", thread_id);

        // For internal pyodide packages like micropip, use loadPackage()
        const micropip = await pyodide.loadPackage("micropip");
        console.log("micropip", micropip);

        await pyodide.runPythonAsync(`
          import inspect
          self = inspect.currentframe()
          id = id(self)

          print(f"-> runPythonAsync start {id}", self)
          print("globals", globals())

          import sys
          import micropip
          #print("--> modules start", sorted(sys.modules.keys()))
          #print(micropip.list()) # shows only 'micropip'

          # TODO: add others

          #print(micropip.list()) # shows only 'micropip'
          #print("<-- modules end", sorted(sys.modules.keys()))
          print(f"<- runPythonAsync exit {id}", self)
        `);

        msg = "main exit " + url
        console.log(msg)
        //console.log("main exit", this);
        if (element)
          element.textContent = msg;
      }

      main();
    </script>
  </body>
</html>
