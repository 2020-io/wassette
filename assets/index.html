<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="mini-coi.js" scope="./"></script>
     <!--
     <script type=</script>
      window.coi = {
        // A function that is run to decide whether to register the SW or not.
        // You could for instance make this return a value based on whether you actually need to be cross origin isolated or not.
        // Using "!reloadedBySelf" you can avoid infinite loops of reloading.
        shouldRegister: () => !reloadedBySelf,
        // If this function returns true, any existing service worker will be deregistered (and nothing else will happen).
        shouldDeregister: () => false,
        // A function that is run to decide whether to use "Cross-Origin-Embedder-Policy: credentialless" or not.
        // See https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cross-Origin-Embedder-Policy#browser_compatibility
        coepCredentialless: () => true,
        // A function to decide whether to retry with require-corp if credentialless fails.
        coepDegrade: () => true,
        // Override this if you want to prompt the user and do reload at your own leisure. Maybe show the user a message saying:
        // "Click OK to refresh the page to enable <...>"
        // You can see window.sessionStorage.getItem("coiReloadedBySelf") for the reason to reload.
        doReload: () => window.location.reload(),
        // Set to true if you don't want coi to log anything to the console.
        quiet: false
      } 
    </script>
    <script src="coi-serviceworker.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/dev/full/pyodide.js"></script>
    -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.28.1/full/pyodide.js"></script>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>

    <script type="text/javascript">
      async function sleepFor(maxcount = null) {
        let counter = 0;
        console.log(`-> sleepFor: enter ${maxcount}`);
        if (maxcount == 0)
            maxcount = null;
        while (!maxcount || counter < maxcount) {
            //console.log(`.. sleepFor: ${counter}`);
            await new Promise(resolve => setTimeout(resolve, 1000));
            counter++;
        }
        console.log(`<- sleepFor: exit ${counter}`);
      }
    </script>
  </head>

  <body>
    <div id="status"></div><br/>
    <div id="url" style="display:none"></div>

<!--
    <div id="wasm"></div>
    <div id="content">Waiting for content...</div>
    <script type="text/javascript">
      console.log("wasm enter", this);
      subwindow = this[0]
      if (subwindow) {
        console.log("subwindow", subwindow)
        console.log("subwindow.location", subwindow.location)
        //this = subwindow
      }

      relative_url = window.location.pathname
      console.log("wasm relative_url", relative_url);

      url = window.location.href
      console.log("wasm url", url);
      document.getElementById("url").innerText = url;

      queryString = window.location.search
      console.assert(typeof(queryString) == 'string') 
      if (queryString && queryString[0] == '?')
        console.log("queryString", queryString)
      const params = new URLSearchParams(queryString)

      content = document.getElementById("content");
      console.log("content", content);
      if (content) {
        element = null;
        text = null;
        //console.log("previous content", content.innerHTML);

        content.innerHTML = "";

        if (params.get('iframe')) {
          // This is the call from the injected <iframe src=...
          target = "/wasm.js"

          element = document.createElement('script');
          element.id = "iframe_script"
          element.type = 'text/javascript';
          //text = 'alert("Target: ' + target + '");';
          element.src = target;
        } else {
          // This is the initial call, so inject an iframe to reload this URL from the iframe

          target = relative_url
          if (target == "/")
            target = "/index.html";

          target += "?iframe=1";
          console.log("target", target);

          element = document.createElement('iframe');
          element.id = 'iframe';
          element.src = target;
        }
      } else {
        content = document.body;
        element = document.createElement('script');
        element.type = 'text/javascript';
        text = 'alert("Called from: ' + url + '");';
      }

      if (element) {
        //console.log("text", text);
        try {
          if (text) {
            text_node = document.createTextNode(text);
            //console.log("child text", text_node);
            element.appendChild(text_node);
          }
          console.log("adding new node", element);
          console.log("adding to parent", content);
          content.appendChild(element);
        } catch (e) {
          console.log("exception", e);
          element.text = text ? text : "";
          console.log("adding new node", element);
          console.log("adding to parent", content);
          content.appendChild(element);
        }
      }

      status = document.getElementById("status");
      msg = "wasm exit " + url;
      console.log(msg);
      //console.log("wasm exit", this);
      if (status)
        status.textContent = msg;
    </script>
-->

    <script type="mpy">
      from js import document
      url = document.getElementById("url").innerText;

      import time
      msg = f"micropython enter {url}"
      print(msg)
      status = document.getElementById("status")
      status.innerText = msg

      #for i in range(1):
      #  print(f"micropython: loop {i}")
      #  time.sleep(1)

      msg = f"micropython exit {url}"
      print(msg)
      status.innerText = msg
    </script>

    <script type="py">
      print("start of pyodide")
      #from pyscript import display
      #display(sys.version)

      import sys

      import inspect
      self = inspect.currentframe()
      id = id(self)
      
      print(f"-> runPython start {id}", self)
      print("globals", globals())
      
      import sys
      print("--> modules start", sorted(sys.modules.keys()))
      
      #import micropip
      #print(micropip.list()) # shows only 'micropip'
      #print(micropip.list()) # shows 'micropip' + newly installed packages
      #print("<-- modules end", sorted(sys.modules.keys()))

      print(f"<- runPython exit {id}", self)
    </script>

    <script type="text/javascript">
      async function main() {
        console.log("main enter", this);
        subwindow = this[0]
        if (subwindow) {
          console.log("subwindow", subwindow)
          console.log("subwindow.location", subwindow.location)
          //this = subwindow
        }

        relative_url = this.location.pathname;
        console.log("main relative_url", url);

        url = this.location.href;
        console.log("main url", url);

        //await sleepFor(1);
        //let element = null;
        //let element = document.body;
        let element = document.getElementById('status');
        if (element)
          element.textContent = "main enter " + url;

        console.log("calling loadPyodide()");
        const pyodide = await loadPyodide();
        console.log("pyodide", pyodide);

        const threading = pyodide.pyimport("threading");
        //console.log("threading", threading); // pyodide Proxy()
        const thread_id = threading.get_ident();
        console.log("thread_id", thread_id);

/*
        iframe_element = document.querySelector('iframe');
        console.log("iframe_element", iframe_element);
        if (iframe_element) {
          iframe_window = iframe_element.contentWindow;
          console.log("iframe_window", iframe_window);

          await pyodide.runPythonAsync(`
            from js import document, window

            iframe_element = document.querySelector("iframe")
            print("iframe_element inside runPython", iframe_element)

            if iframe_element:
              iframe_window = iframe_element.contentWindow;
              print("iframe_window", iframe_window)

              iframe_document = iframe_window.document
              iframe_wasm = iframe_document.querySelector("#wasm");
              if iframe_wasm:
                print("iframe_wasm", iframe_wasm)
                target = iframe_wasm
                print(f"wasm innerText", target.innerText)
                print(f"wasm innerHTML", target.innerHTML)

                wasm = target.innerHTML;
                print("wasm", wasm) # TODO: use it

                if wasm and len(wasm) > 0:
                  print("Removing old iframe", iframe_element)
                  iframe_element.outerHTML = "" # overwrite the iframe
                  iframe_element = None
          `);
          console.log("old iframe", iframe_element); // this should be deleted now
          iframe_element = null;
        } else {
          await pyodide.runPython(`
            import inspect
            self = inspect.currentframe()
            id = id(self)

            print(f"-> runPython start {id}", self)
            print("globals", globals())

            import sys
            #print("--> modules start", sorted(sys.modules.keys()))
            import micropip
            #print(micropip.list()) # shows only 'micropip'

            print(micropip.list()) # shows only 'micropip'
            #print("<-- modules end", sorted(sys.modules.keys()))
            print(f"<- runPython exit {id}", self)
          `);
        }
*/

        msg = "main exit " + url
        console.log(msg)
        //console.log("main exit", this);
        if (element)
          element.textContent = msg;
      }

      main();
    </script>
  </body>
</html>
